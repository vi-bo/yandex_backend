## Архитектура распределенных систем

Первоисточник: [Архитектура распределенных систем - YouTube](https://www.youtube.com/watch?v=VoDGD_-d-Sg)

**План лекции:**

1. CAP-теорема

2. Eventual consistency

3. Распределенные СУБД

4. Репликация

5. Восемь заблуждений распределенных систем

6. Идемпотентность

7. Патерны в проектировании распределенных систем

### Введение

- Планирование нагрузки

- Требование к надежности (SLA)

SLA (Service Level Agreement) - 90%, 99%, 99,9% и т.д. - соглашение об уровне сервиса, % доступности сервиса в день, неделю, месяц, год.

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-22-32-51-image.png" title="" alt="" data-align="center">

### 1. CAP-теорема

CAP-теорема - в любой системе можно обеспечить неболее двух свойств:

- С (Consistency) - консистентность

- А (Availability) - доступность

- Р (partition tolerance) - устойчивость к разделению

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-22-36-14-image.png" title="" alt="" data-align="center">

Главный вывод CAP-теоремы: **При разделении система или консистентна (С) или доступна (А).**

Виды систем:

- CP - отказ (например, PostgeSQL);

- АР - всегда доступна (например, MongoDB);

- СА - не существует.

СА-система только на локальном ноутбуке, как только работает по сети - СА-системы не существует.

### 2. Eventual consistency

Eventual consistency - согласованность в конечном счете (разрешение конфликтов).

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-22-47-53-image.png" title="" alt="" data-align="center">

### 3. Распределенные СУБД

**Портицирование** - когда данных очень много делаем три PostgreSQL, куда можно записывать данные. В общем случае деление данных на части, эти части можно положить на разные сервера, а можно в разные таблицы. Например, портиция по дням (для заказов).

- Умный клиент (ставить четвертый PostgreSQL - больно);

- Умный сервер (MongoDB - неравномерная нагрузка на серверы).

Умный клиент vs. Умный сервер (в зависимости от требований заказчика).

**Шардирование** - это когда мы раскладываем на разные сервера.

### 4. Репликация

**Репликация** -   когда данные из одного сервера переходят в другой сервер.

**Синхронная репликация** - master отвечает только после подтверждения реплик.

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-22-58-58-image.png" title="" alt="" data-align="center">

**Асинхронная репликация** - master отвечает сразу, запись в реплики осуществляется потом.

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-23-00-01-image.png" title="" alt="" data-align="center">

Смешанная репликация - несколько синхронных реплик и много асинхронных. 

Master - почитать/записать.

Реплика - почитать.

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-23-01-06-image.png" title="" alt="" data-align="center">

Кворум БД - если узлы знают свою роль (master, реплика).

### 5. Восемь заблуждений распределенных систем

*Заблуждения на то и заблуждения, чтобы в них верили (с).*

...и что делать?

1. Сеть надежна
   
   - обрабатывать сетевые ошибки

2. Задержка равна нулю
   
   - не привязывать бизнес-логику ко времени выполнения операции
   
   - переместить данные ближе к клиенту
   
   - инвертируйте поток данных
   
   - верните все данные, которые могут понадобиться клиенту

3. Канал передачи данных очень широкий
   
   - передавайте только те данные, которые нужны
   
   - используйте сжатие (http)

4. Сеть безопасна
   
   - шифруйте данные (TLS/SSL - за датацентром)

5. Топология сети не поменяется
   
   - проектируйте систему так, чтобы повторы запросов не поменяли логику

6. Есть один администратор
   
   - DevOps - методология разработки ПО
   
   - infrastructure as code

7. Транспортные расходы равны нулю ($)
   
   - экономьте трафик
   
   - мониторинг трафика, соотношение входящий/исходящий

8. Сеть гомогенная (одинаковые уловия у всех)
   
   - попробовать выполнить эмуляцию в Edge с потерей 1% пакетов 

### 6. Идемпотентность

2+2 = 4, 2*2 = 4 ->  сколько раз нне считай, получаем одно и тоже.

<img src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-23-16-18-image.png" title="" alt="" data-align="center">

**Idempotency Key in SOA (Service Oriented Architecture)**

<img title="" src="file:///home/vibo/Pictures/GlobalMarkText/2022-08-30-23-17-12-image.png" alt="" data-align="center">

### 7. Паттерны в проектировании распределенных систем

- КЭШ

- Повторы (повторяем запрос пока не получим нужный результат на стороне сервера)

- Предохранитель

- Асинхронные запросы
